name: Run Jest Tests on PR

on:
  pull_request:
    branches: ['**'] # Runs for PRs targeting any branch

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3

      - name: üü¢ Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: üì¶ Install dependencies
        run: npm ci --legacy-peer-deps

      - name: üåê Set Vercel Preview URL
        id: vercel-url
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          SLUGIFIED_NAME=$(echo "$BRANCH_NAME" | tr '[:upper:]' '[:lower:]' | tr '/' '-' | tr '_' '-')
          echo "TEST_BASE_URL=https://process-flow-git-${SLUGIFIED_NAME}-mtogbes-projects.vercel.app" >> $GITHUB_ENV

      - name: üìù Log TEST_BASE_URL
        run: echo "TEST_BASE_URL=$TEST_BASE_URL"
        env:
          TEST_BASE_URL: ${{ env.TEST_BASE_URL }}

      - name: üß™ Run Jest tests
        run: npm run test
        env:
          TEST_BASE_URL: ${{ env.TEST_BASE_URL }}
          VERCEL_AUTOMATION_BYPASS_SECRET: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}
