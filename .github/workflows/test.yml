name: Run Jest Tests on PR

on:
  pull_request:
    branches: ['**']

permissions:
  contents: read
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref || github.ref_name }}
          fetch-depth: 0

      - name: üü¢ Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: üì¶ Install dependencies
        run: npm ci --legacy-peer-deps

      # --- Vercel CLI Deployment Steps ---
      - name: üì§ Install Vercel CLI
        run: npm install --global vercel@latest

      - name: üì• Pull Vercel environment variables
        run: vercel pull --yes --environment=${{ github.head_ref == 'main' && 'production' || 'preview' }} --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: üîß Build project using Vercel CLI
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: üöÄ Deploy to Vercel with prebuilt output
        id: vercel_deploy
        run: |
          if [ "${{ github.head_ref }}" = "main" ]; then
            vercel_url=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }} | tail -1)
          else
            vercel_url=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }} | tail -1)
          fi
          echo "VERCEL_DEPLOYMENT_URL=$vercel_url" >> $GITHUB_ENV
          echo "Deployed to: $vercel_url"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

      - name: üìù Log Preview URL
        run: echo "Preview URL is $VERCEL_DEPLOYMENT_URL"

      - name: üé≠ Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: üé≠ Run Playwright E2E tests
        run: npx playwright test
        env:
          TEST_BASE_URL: ${{ env.VERCEL_DEPLOYMENT_URL }}
          VERCEL_AUTOMATION_BYPASS_SECRET: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}

      - name: üß™ Run Cucumber E2E tests
        run: npx cucumber-js "e2e/features/**/*.feature" --require-module ts-node/register --require "e2e/step-definitions/**/*.steps.ts"
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          TEST_BASE_URL: ${{ env.VERCEL_DEPLOYMENT_URL }}
          VERCEL_AUTOMATION_BYPASS_SECRET: ${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}
