generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  ADMIN
  EDITOR
  READER
}

enum BlockType {
  DELAY
  STEP
  PATH
}

model User {
  id            Int         @id @default(autoincrement())
  name          String
  email         String      @unique
  password      String
  actions       Action[]    @relation("UserActions")
  userTeams     UserTeam[]
}

model Team {
  id         Int         @id @default(autoincrement())
  name       String
  userTeams  UserTeam[]
  workspaces Workspace[]
}

model UserTeam {
  id     Int     @id @default(autoincrement())
  userId Int
  teamId Int
  role   Role
  poles  String[]
  user   User    @relation(fields: [userId], references: [id])
  team   Team    @relation(fields: [teamId], references: [id])

  @@unique([userId, teamId])
}

model Workflow {
  id           Int        @id @default(autoincrement())
  name         String
  workspaceId  Int
  workspace    Workspace  @relation(fields: [workspaceId], references: [id])
  blocks       Block[]    @relation("WorkflowBlocks")
  history      Action[]   @relation("WorkflowActions")

  @@unique([name, workspaceId])
}

model Path {
  id          Int          @id @default(autoincrement())
  name        String       // Optional name for easier management of paths
  blocks      Block[]      @relation("PathBlocks") // One-to-many relation with Block
  pathBlockId Int          // Foreign key to PathBlock
  pathBlock   PathBlock    @relation("PathBlockPath", fields: [pathBlockId], references: [id])
}

model Block {
  id                Int          @id @default(autoincrement())
  type              BlockType
  position          Int
  icon              String?      // Optional field
  description       String?      // Optional field
  workflowId        Int
  workflow          Workflow     @relation("WorkflowBlocks", fields: [workflowId], references: [id])
  actions           Action[]
  delayBlock        DelayBlock?
  stepBlock         StepBlock?
  pathBlock         PathBlock?
  pathId            Int          // Required field to link to Path
  path              Path         @relation("PathBlocks", fields: [pathId], references: [id])
}

model PathBlock {
  id           Int         @id @default(autoincrement())
  blockId      Int         @unique
  block        Block       @relation(fields: [blockId], references: [id])
  paths        Path[]      @relation("PathBlockPath")
}


model DelayBlock {
  id          Int   @id @default(autoincrement())
  blockId     Int   @unique
  delay       Int   // Specific field for Delay block
  block       Block @relation(fields: [blockId], references: [id])
}

model StepBlock {
  id          Int   @id @default(autoincrement())
  blockId     Int   @unique
  stepDetails String // Specific field for Step block
  block       Block @relation(fields: [blockId], references: [id])
}

model Action {
  id         Int      @id @default(autoincrement())
  userId     Int
  user       User     @relation("UserActions", fields: [userId], references: [id])
  type       String
  targetId   Int
  target     Block    @relation(fields: [targetId], references: [id])
  workflowId Int
  workflow   Workflow @relation("WorkflowActions", fields: [workflowId], references: [id])
  value      Int
}

model Todo {
  id    Int @id @default(autoincrement())
  title String
}

model Workspace {
  id        Int        @id @default(autoincrement())
  name      String
  teamId    Int
  team      Team       @relation(fields: [teamId], references: [id])
  workflows Workflow[]
}
