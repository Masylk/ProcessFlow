generator client {
  provider = "prisma-client-js"
}

generator dbml {
  provider = "prisma-dbml-generator"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum onboarding_step {
  PERSONAL_INFO
  PROFESSIONAL_INFO
  WORKSPACE_SETUP
  INVITED_USER
  COMPLETED
}

enum user_role {
  ADMIN
  EDITOR
  READER
}

enum block_type {
  DELAY
  STEP
  BEGIN
  END
  PATH
  LAST
}

enum subscription_status {
  ACTIVE
  TRIALING
  CANCELED
}

enum plan_type {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum task_type {
  MANUAL
  AUTOMATIC
}

model user {
  id                        Int                @id @default(autoincrement())
  created_at               DateTime           @default(now())
  updated_at               DateTime           @default(now()) @updatedAt
  archived_at              DateTime?
  auth_id                  String             @unique
  first_name               String
  last_name                String
  full_name                String
  email                    String             @unique
  avatar_url               String?
  active_workspace_id      Int?
  hubspot_contact_id       String?
  sentry_id                String?
  post_hog_id              String?
  phone                    String?
  last_login_at            DateTime?
  onboarding_step          onboarding_step?   @default(PERSONAL_INFO)
  onboarding_completed_at  DateTime?
  
  // Professional Info fields - Individual specific
  professional_role     String?   // renamed from 'role' to avoid confusion with user_role enum
  source                String?   // How this user found the platform
  
  // Temporary fields for onboarding process
  temp_industry         String?
  temp_company_size     String?
  
  // Relations
  active_workspace         workspace?         @relation("active_workspace", fields: [active_workspace_id], references: [id])
  workspaces              user_workspace[]
  actions                 action[]

  @@index([active_workspace_id])
  @@index([email])
  @@index([auth_id])
  @@map("user")
}

model workspace {
  id                   Int                   @id @default(autoincrement())
  created_at           DateTime              @default(now())
  updated_at           DateTime              @default(now()) @updatedAt
  archived_at          DateTime?
  name                 String
  slug                 String?                @unique
  team_tags           String[]
  icon_url            String?
  background_colour   String?
  linear_customer_id   String?
  stripe_customer_id   String?
  hubspot_company_id   String?
  subscription_id      Int?                  @unique
  
  // Company Info fields - moved from user table
  industry            String?
  company_size        String?
  
  // Relations
  subscription         subscription?         @relation(fields: [subscription_id], references: [id])
  billing_infos        workspace_billing_infos[]
  user_workspaces      user_workspace[]
  active_users         user[]               @relation("active_workspace")
  folders              folder[]
  workflows            workflow[]
  billings             billing[]
  invitations          invitation[]

  @@index([stripe_customer_id])
  @@index([subscription_id])
  @@map("workspace")
}

model workspace_billing_infos {
  id              Int       @id @default(autoincrement())
  created_at      DateTime  @default(now())
  updated_at      DateTime  @default(now()) @updatedAt
  billing_email   String
  billing_address String
  tax_rate        Decimal   @db.Decimal(5,2)
  vat_number      String?
  workspace_id    Int
  workspace       workspace @relation(fields: [workspace_id], references: [id])

  @@index([workspace_id])
  @@map("workspace_billing_infos")
}

model subscription {
  id                    Int                 @id @default(autoincrement())
  created_at            DateTime            @default(now())
  updated_at            DateTime            @default(now()) @updatedAt
  canceled_at           DateTime?
  workspace_id          Int                 @unique
  stripe_subscription_id String
  trial_end_date        DateTime?
  plan_type             plan_type
  quantity_seats        Int
  current_period_start  DateTime
  current_period_end    DateTime
  status                subscription_status
  workspace             workspace?
  billings              billing[]

  @@map("subscription")
}

model billing {
  id                 Int          @id @default(autoincrement())
  created_at         DateTime     @default(now())
  updated_at         DateTime     @default(now()) @updatedAt
  paid_at            DateTime?
  subscription_id    Int
  stripe_invoice_id  String       @unique
  amount_net         Int          // Amount in cents
  tax_amount         Int          // Amount in cents
  amount_gross       Int          // Amount in cents
  currency           String       @db.VarChar(3)
  invoice_date       DateTime
  due_date           DateTime
  workspace_id       Int
  subscription       subscription @relation(fields: [subscription_id], references: [id])
  workspace          workspace    @relation(fields: [workspace_id], references: [id])

  @@index([subscription_id])
  @@index([workspace_id])
  @@index([stripe_invoice_id])
  @@map("billing")
}

model user_workspace {
  id           Int       @id @default(autoincrement())
  user_id      Int
  workspace_id Int
  role         user_role @default(ADMIN)

  user      user      @relation(fields: [user_id], references: [id])
  workspace workspace @relation(fields: [workspace_id], references: [id])

  @@index([user_id, workspace_id], name: "user_workspace_composite_idx")
  @@index([user_id])
  @@index([workspace_id])
  @@map("user_workspace")
}

model invitation {
  id              Int         @id @default(autoincrement())
  created_at      DateTime    @default(now())
  updated_at      DateTime    @default(now()) @updatedAt
  email           String
  token           String      @unique
  expires_at      DateTime
  used            Boolean     @default(false)
  used_at         DateTime?
  workspace_id    Int
  role            user_role   @default(READER)
  
  workspace       workspace   @relation(fields: [workspace_id], references: [id])

  @@index([workspace_id])
  @@index([token])
  @@index([email])
  @@map("invitation")
}

model folder {
  id            Int         @id @default(autoincrement())
  name          String
  workspace_id  Int
  parent_id     Int?
  icon_url      String?
  emote         String?
  team_tags     String[]
  path          String?     // Materialized path for efficient tree queries
  
  workspace     workspace   @relation(fields: [workspace_id], references: [id])
  parent        folder?     @relation("folder_hierarchy", fields: [parent_id], references: [id])
  subfolders    folder[]    @relation("folder_hierarchy")
  workflows     workflow[]

  @@index([workspace_id])
  @@index([parent_id])
  @@index([path])
  @@map("folder")
}

model workflow {
  id            Int         @id @default(autoincrement())
  created_at    DateTime    @default(now())
  updated_at    DateTime    @default(now()) @updatedAt
  last_opened   DateTime?
  name          String
  description   String
  workspace_id  Int
  team_tags     String[]
  folder_id     Int?
  is_public         Boolean  @default(false)
  public_access_id  String?  @unique // This will be our shareable ID
  
  workspace     workspace   @relation(fields: [workspace_id], references: [id])
  folder        folder?     @relation(fields: [folder_id], references: [id])
  blocks        block[]
  paths         path[]
  actions       action[]

  @@unique([name, workspace_id])
  @@index([workspace_id])
  @@index([folder_id])
  @@map("workflow")
}

/// Collection of connected blocks forming a workflow path
model path {
  id             Int       @id @default(autoincrement())
  name           String
  workflow_id    Int
  
  workflow       workflow  @relation(fields: [workflow_id], references: [id])
  blocks         block[]
  parent_blocks  path_parent_block[]

  @@index([workflow_id])
  @@map("path")
}

/// Junction table that allows paths to be triggered from multiple parent blocks
model path_parent_block {
  path_id        Int
  block_id       Int
  created_at     DateTime  @default(now())

  path           path      @relation(fields: [path_id], references: [id], onDelete: Cascade)
  block          block     @relation("path_parent", fields: [block_id], references: [id], onDelete: Cascade)

  @@id([path_id, block_id])
  @@index([path_id])
  @@index([block_id])
  @@map("path_parent_block")
}

model block {
  id                Int       @id @default(autoincrement())
  created_at        DateTime  @default(now())
  updated_at        DateTime  @default(now()) @updatedAt
  last_modified     DateTime?
  type              block_type
  
  // Type-specific fields
  step_details      String?   // Used when type is STEP
  delay_seconds     Int?      // Used when type is DELAY
  
  position          Int
  title             String?
  icon              String?
  description       String?
  image             String?
  image_description String?
  average_time      String?
  task_type         task_type?
  workflow_id       Int
  path_id           Int
  click_position    Json?
  
  workflow          workflow            @relation(fields: [workflow_id], references: [id], onDelete: Cascade)
  path              path                @relation(fields: [path_id], references: [id], onDelete: Cascade)
  actions           action[]
  child_paths       path_parent_block[] @relation("path_parent")

  @@index([workflow_id])
  @@index([path_id])
  @@index([type])
  @@map("block")
}

model action {
  id           Int       @id @default(autoincrement())
  user_id      Int
  type         String
  target_id    Int
  workflow_id  Int
  value        Int
  created_at   DateTime  @default(now())
  
  user         user      @relation(fields: [user_id], references: [id])
  target       block     @relation(fields: [target_id], references: [id])
  workflow     workflow  @relation(fields: [workflow_id], references: [id])

  @@index([user_id])
  @@index([target_id])
  @@index([workflow_id])
  @@index([created_at])
  @@map("action")
}