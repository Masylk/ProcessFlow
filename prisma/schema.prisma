generator client {
  provider = "prisma-client-js"
}

generator dbml {
  provider = "prisma-dbml-generator"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum role {
  ADMIN
  EDITOR
  READER
}

enum block_type {
  DELAY
  STEP
  PATH
}

enum subscription_status {
  ACTIVE
  TRIALING
  CANCELED
}

enum plan_type {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

model user {
  id                 Int              @id @default(autoincrement())
  auth_id            String           @unique
  first_name         String
  last_name          String
  full_name          String
  email              String           @unique
  avatar_url         String?
  active_workspace_id Int?            // ID du workspace actif
  hubspot_contact_id String?
  sentry_id          String?
  post_hog_id        String?
  phone              String?
  archived_at        DateTime?
  created_at         DateTime         @default(now())
  updated_at         DateTime         @default(now()) @updatedAt
  last_login_at      DateTime?
  
  // Relations
  active_workspace    workspace?      @relation("active_workspace", fields: [active_workspace_id], references: [id])
  user_workspaces    user_workspace[] // Permet d'avoir plusieurs workspaces
  actions            action[]         @relation("user_actions")

  @@index([active_workspace_id])
  @@index([email])
  @@index([auth_id])
  @@index([auth_id], name: "auth_id_cover_idx")
}

model workspace {
  id                   Int                   @id @default(autoincrement())
  name                 String
  team_tags           String[]
  icon_url            String?
  background_colour   String?
  linear_customer_id   String?
  stripe_customer_id   String?
  hubspot_company_id   String?
  archived_at          DateTime?
  created_at           DateTime              @default(now())
  updated_at           DateTime              @default(now()) @updatedAt
  subscription_id      Int?                  @unique
  
  // Relations
  subscription         subscription?         @relation(fields: [subscription_id], references: [id])
  billing_infos        workspace_billing_infos[]
  user_workspaces      user_workspace[]     // Relation many-to-many avec users
  active_users         user[]               @relation("active_workspace") // Users qui ont ce workspace comme actif
  folders              folder[]
  workflows            workflow[]

  @@index([stripe_customer_id])
  @@index([subscription_id])
}

model workspace_billing_infos {
  id              Int       @id @default(autoincrement())
  created_at      DateTime  @default(now())
  updated_at      DateTime  @default(now()) @updatedAt
  billing_email   String
  billing_address String
  tax_rate        Decimal   @db.Decimal(5,2)
  vat_number      String?
  workspace_id    Int
  workspace       workspace @relation(fields: [workspace_id], references: [id])

  @@index([workspace_id])
}

model subscription {
  id                    Int                 @id @default(autoincrement())
  workspace_id          Int                 @unique
  workspace             workspace?
  stripe_subscription_id String
  created_at            DateTime            @default(now())
  updated_at            DateTime            @default(now()) @updatedAt
  trial_end_date        DateTime?
  plan_type             plan_type
  quantity_seats        Int
  current_period_start  DateTime
  current_period_end    DateTime
  status                subscription_status
  canceled_at           DateTime?
  billings              billing[]
}

model billing {
  id                 Int          @id @default(autoincrement())
  subscription_id    Int
  subscription       subscription @relation(fields: [subscription_id], references: [id])
  stripe_invoice_id  String       @unique
  amount_net         Int          // Montant en centimes
  tax_amount         Int          // Montant en centimes
  amount_gross       Int          // Montant en centimes
  currency           String       @db.VarChar(3)
  invoice_date       DateTime
  due_date           DateTime
  paid_at            DateTime?
  created_at         DateTime     @default(now())
  updated_at         DateTime     @default(now()) @updatedAt

  @@index([subscription_id])
  @@index([stripe_invoice_id])
}

model user_workspace {
  id           Int       @id @default(autoincrement())
  user_id      Int
  workspace_id Int
  role         role      @default(ADMIN)

  user      user      @relation(fields: [user_id], references: [id])
  workspace workspace @relation(fields: [workspace_id], references: [id])

  @@index([user_id, workspace_id], name: "user_workspace_composite_idx")
  @@index([user_id])
  @@index([workspace_id])
}

model folder {
  id           Int    @id @default(autoincrement())
  name         String
  workspace_id Int
  parent_id    Int? // Nullable field for nesting folders
  icon_url     String?
  emote        String?
  team_tags   String[]

  workspace  workspace @relation(fields: [workspace_id], references: [id])
  parent     folder?   @relation("folder_hierarchy", fields: [parent_id], references: [id])
  subfolders folder[]  @relation("folder_hierarchy")

  workflows workflow[]
}

model workflow {
  id           Int       @id @default(autoincrement())
  name         String
  description  String
  workspace_id Int
  team_tags    String[]
  workspace    workspace @relation(fields: [workspace_id], references: [id])
  blocks       block[]   @relation("workflow_blocks")
  history      action[]  @relation("workflow_actions")
  paths        path[]    @relation("workflow_paths")
  folder       folder?   @relation(fields: [folder_id], references: [id])
  folder_id    Int?
  last_opened  DateTime?

  @@unique([name, workspace_id])
}

enum task_type {
  MANUAL
  AUTOMATIC
}

model path {
  id            Int         @id @default(autoincrement())
  name          String
  blocks        block[]     @relation("path_blocks")
  path_block_id Int?
  path_block    path_block? @relation("path_block_path", fields: [path_block_id], references: [id], onDelete: Cascade)
  workflow_id   Int
  workflow      workflow    @relation("workflow_paths", fields: [workflow_id], references: [id])
}

model block {
  id                Int          @id @default(autoincrement())
  type              block_type
  position          Int
  title             String?
  icon              String?
  description       String?
  image             String?
  image_description String?
  last_modified     DateTime?
  average_time      String?
  task_type         task_type?
  workflow_id       Int
  workflow          workflow     @relation("workflow_blocks", fields: [workflow_id], references: [id], onDelete: Cascade)
  actions           action[]
  step_block        step_block?  @relation
  path_block        path_block?  @relation
  delay_block       delay_block? @relation
  path_id           Int
  path              path         @relation("path_blocks", fields: [path_id], references: [id], onDelete: Cascade)
  click_position    Json?
}

model step_block {
  id           Int    @id @default(autoincrement())
  block_id     Int    @unique
  step_details String
  block        block  @relation(fields: [block_id], references: [id], onDelete: Cascade)
}

model path_block {
  id       Int    @id @default(autoincrement())
  block_id Int    @unique
  block    block  @relation(fields: [block_id], references: [id], onDelete: Cascade)
  paths    path[] @relation("path_block_path") // Do not define `onDelete` here
}

model delay_block {
  id       Int   @id @default(autoincrement())
  block_id Int   @unique
  block    block @relation(fields: [block_id], references: [id], onDelete: Cascade)
  seconds  Int
}

model action {
  id          Int      @id @default(autoincrement())
  user_id     Int
  user        user     @relation("user_actions", fields: [user_id], references: [id])
  type        String
  target_id   Int
  target      block    @relation(fields: [target_id], references: [id])
  workflow_id Int
  workflow    workflow @relation("workflow_actions", fields: [workflow_id], references: [id])
  value       Int
}
