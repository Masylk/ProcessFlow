generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum role {
  ADMIN
  EDITOR
  READER
}

enum block_type {
  DELAY
  STEP
  PATH
}

model user {
  id              Int              @id @default(autoincrement()) // Keep id as Int
  auth_id         String           @unique // New field to store Supabase Auth UID
  first_name      String
  last_name       String
  full_name       String
  email           String           @unique
  avatar_url      String?
  active_workspace Int?
  actions         action[]         @relation("user_actions")
  user_workspaces user_workspace[]
}


model workspace {
  id        Int      @id @default(autoincrement())
  name      String
  team_tags String[]
  icon_url  String?
  background_colour String?

  user_workspaces user_workspace[]
  folders         folder[]
  workflows       workflow[]
}

model user_workspace {
  id           Int  @id @default(autoincrement())
  user_id      Int
  workspace_id Int
  role         role

  user      user      @relation(fields: [user_id], references: [id])
  workspace workspace @relation(fields: [workspace_id], references: [id])

  @@unique([user_id, workspace_id])
}

model folder {
  id           Int    @id @default(autoincrement())
  name         String
  workspace_id Int
  parent_id    Int? // Nullable field for nesting folders
  icon_url     String?
  emote        String?
  team_tags   String[]

  workspace  workspace @relation(fields: [workspace_id], references: [id])
  parent     folder?   @relation("folder_hierarchy", fields: [parent_id], references: [id])
  subfolders folder[]  @relation("folder_hierarchy")

  workflows workflow[]
}

model workflow {
  id           Int       @id @default(autoincrement())
  name         String
  description  String
  workspace_id Int
  team_tags    String[]
  workspace    workspace @relation(fields: [workspace_id], references: [id])
  blocks       block[]   @relation("workflow_blocks")
  history      action[]  @relation("workflow_actions")
  paths        path[]    @relation("workflow_paths")
  folder       folder?   @relation(fields: [folder_id], references: [id])
  folder_id    Int?
  last_opened  DateTime?

  @@unique([name, workspace_id])
}

enum task_type {
  MANUAL
  AUTOMATIC
}

model path {
  id            Int         @id @default(autoincrement())
  name          String
  blocks        block[]     @relation("path_blocks")
  path_block_id Int?
  path_block    path_block? @relation("path_block_path", fields: [path_block_id], references: [id], onDelete: Cascade)
  workflow_id   Int
  workflow      workflow    @relation("workflow_paths", fields: [workflow_id], references: [id])
}

model block {
  id                Int          @id @default(autoincrement())
  type              block_type
  position          Int
  title             String?
  icon              String?
  description       String?
  image             String?
  image_description String?
  last_modified     DateTime?
  average_time      String?
  task_type         task_type?
  workflow_id       Int
  workflow          workflow     @relation("workflow_blocks", fields: [workflow_id], references: [id], onDelete: Cascade)
  actions           action[]
  step_block        step_block?  @relation
  path_block        path_block?  @relation
  delay_block       delay_block? @relation
  path_id           Int
  path              path         @relation("path_blocks", fields: [path_id], references: [id], onDelete: Cascade)
  click_position    Json?
}

model step_block {
  id           Int    @id @default(autoincrement())
  block_id     Int    @unique
  step_details String
  block        block  @relation(fields: [block_id], references: [id], onDelete: Cascade)
}

model path_block {
  id       Int    @id @default(autoincrement())
  block_id Int    @unique
  block    block  @relation(fields: [block_id], references: [id], onDelete: Cascade)
  paths    path[] @relation("path_block_path") // Do not define `onDelete` here
}

model delay_block {
  id       Int   @id @default(autoincrement())
  block_id Int   @unique
  block    block @relation(fields: [block_id], references: [id], onDelete: Cascade)
  seconds  Int
}

model action {
  id          Int      @id @default(autoincrement())
  user_id     Int
  user        user     @relation("user_actions", fields: [user_id], references: [id])
  type        String
  target_id   Int
  target      block    @relation(fields: [target_id], references: [id])
  workflow_id Int
  workflow    workflow @relation("workflow_actions", fields: [workflow_id], references: [id])
  value       Int
}
